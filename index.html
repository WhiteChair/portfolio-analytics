<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Portfolio Analytics</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" crossorigin></script>
  <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      min-height: 100vh;
      color: #e2e8f0;
    }
    @keyframes loading {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: rgba(148, 163, 184, 0.3);
      border-radius: 4px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #06b6d4, #8b5cf6);
      border-radius: 50%;
      cursor: pointer;
    }
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo } = React;
    const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, AreaChart, Area, CartesianGrid, Legend, LineChart, Line } = window.Recharts;

    // CSV Parser - handles BOM and quoted values
    const parseCSV = (text) => {
      // Remove BOM if present
      if (text.charCodeAt(0) === 0xFEFF) {
        text = text.slice(1);
      }
      
      const lines = text.trim().split('\n');
      const headers = parseCSVLine(lines[0]);
      
      return lines.slice(1).map(line => {
        const values = parseCSVLine(line);
        const row = {};
        headers.forEach((header, i) => {
          row[header] = values[i] || '';
        });
        return row;
      });
    };
    
    // Parse a single CSV line handling quotes properly
    const parseCSVLine = (line) => {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++; // Skip escaped quote
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim());
      return values;
    };

    // Transform bank data - handles multiple CSV formats
    const transformBankData = (rawData) => {
      return rawData.map(row => {
        // Detect format based on available columns
        // Format 1 (raw DB): Pot, Assets, Instrument Name, ISIN, Mkt Val, Quantity, Ptf Wgt %, Unr P&L %, Pos Cur
        // Format 2 (old): Pot, Instrument Name, ISIN, Mkt Val, Quantity, Portfolio weight %, Unr P&L %, Pos Cur
        // Format 3 (new): Category, Product Name, Quantity, Price, Currency, Value (EUR), Yield/Performance Since Purchase
        
        const isNewFormat = row['Category'] !== undefined || row['Product Name'] !== undefined;
        const isRawDBFormat = row['Assets'] !== undefined || row['Ptf Wgt %'] !== undefined;
        
        let pot, name, isin, mktVal, quantity, currency, unrealizedPLPct, price, assets;
        
        if (isNewFormat) {
          // New format (Jan 2026 simplified)
          pot = row['Category'] || '';
          name = row['Product Name'] || '';
          isin = '';
          mktVal = parseFloat((row['Value (EUR)'] || '0').toString().replace(/,/g, '')) || 0;
          quantity = parseFloat((row['Quantity'] || '0').toString().replace(/,/g, '')) || 0;
          currency = row['Currency'] || 'EUR';
          price = parseFloat((row['Price'] || '0').toString().replace(/,/g, '')) || 0;
          const perfStr = row['Yield/Performance Since Purchase'] || '0%';
          unrealizedPLPct = parseFloat(perfStr.replace('%', '').replace('+', '')) || 0;
          assets = '';
        } else {
          // Raw DB format or old format
          pot = row['Pot'] || '';
          name = row['Instrument Name'] || '';
          isin = row['ISIN'] || '';
          mktVal = parseFloat((row['Mkt Val'] || row['Pos Mkt Val'] || '0').toString().replace(/,/g, '')) || 0;
          quantity = parseFloat((row['Quantity'] || '0').toString().replace(/,/g, '')) || 0;
          currency = row['Pos Cur'] || 'EUR';
          unrealizedPLPct = parseFloat((row['Unr P&L %'] || '0').toString().replace(/,/g, '')) || 0;
          price = parseFloat((row['Price'] || '0').toString().replace(/,/g, '')) || 0;
          assets = row['Assets'] || ''; // Raw DB format has this column
        }
        
        // Skip empty rows
        if (!name || name === 'Unknown' || mktVal === 0) return null;
        
        // Determine type based on category/pot/assets and name
        let type = 'Other';
        const nameLower = name.toLowerCase();
        const potLower = pot.toLowerCase();
        const assetsLower = assets.toLowerCase();
        
        // Check for cash - multiple ways to identify
        if (potLower === 'cash' || potLower === 'liquiditeiten' || potLower.includes('cash')) {
          type = 'Cash';
        } else if (assetsLower === 'eur' || assetsLower === 'usd') {
          type = 'Cash';
        }
        // Check for bonds
        else if (assetsLower === 'obligaties' || nameLower.includes('bond') || nameLower.includes('ultrashort')) {
          type = 'Bond ETF';
        }
        // Check for funds/ETFs
        else if (potLower === 'funds' || nameLower.includes('etf') || nameLower.includes('vanguard') || nameLower.includes('ishares') || nameLower.includes('ftse') || nameLower.includes('s&p')) {
          type = 'Equity ETF';
        }
        // Check for stocks
        else if (potLower === 'stocks' || potLower === 'groei' || assetsLower === 'aandelen' || isin) {
          // Distinguish between individual stocks and ETFs in the GROEI pot
          if (nameLower.includes('vanguard') || nameLower.includes('ishares') || nameLower.includes('etf')) {
            type = 'Equity ETF';
          } else {
            type = 'Stock';
          }
        }
        
        // Try to match ISIN by product name if not provided
        if (!isin) {
          isin = matchIsinByName(name);
        }
        
        return {
          pot,
          name,
          isin,
          mktVal,
          quantity,
          portfolioWeight: parseFloat(row['Ptf Wgt %'] || row['Portfolio weight %'] || '0') || 0,
          unrealizedPL: parseFloat((row['Unr P&L'] || '0').toString().replace(/,/g, '')) || 0,
          unrealizedPLPct,
          currency,
          type,
          price,
          assets,
        };
      }).filter(row => row !== null);
    };
    
    // Match ISIN by product name for new format CSVs
    const matchIsinByName = (name) => {
      const nameLower = name.toLowerCase();
      
      const nameToIsin = {
        'ultrashort bond': 'IE00BCRY6227',
        'ishares': 'IE00BCRY6227',
        'alphabet': 'US02079K1079',
        'berkshire': 'US0846707026',
        'blackrock': 'US09290D1019',
        'sofina': 'BE0003717312',
        'developed world': 'IE00BKX55T58',
        'ftse developed': 'IE00BKX55T58',
        'emerging market': 'IE00B3VVMM84',
        'ftse emerging': 'IE00B3VVMM84',
        's&p 500': 'IE00B3XXRP09',
        'vanguard s&p': 'IE00B3XXRP09',
      };
      
      for (const [key, isin] of Object.entries(nameToIsin)) {
        if (nameLower.includes(key)) {
          return isin;
        }
      }
      
      return '';
    };

    // Ticker mapping for known securities
    const tickerMap = {
      'IE00BCRY6227': { ticker: 'NEAR', name: 'iShares Ultrashort Bond', dividend: 4.8 },
      'US02079K1079': { ticker: 'GOOG', name: 'Alphabet', dividend: 0.0 },
      'US0846707026': { ticker: 'BRK.B', name: 'Berkshire Hathaway', dividend: 0.0 },
      'US09290D1019': { ticker: 'BLK', name: 'BlackRock', dividend: 2.3 },
      'BE0003717312': { ticker: 'SOF.BR', name: 'Sofina', dividend: 1.1 },
      'IE00BKX55T58': { ticker: 'VDEV.AS', name: 'Vanguard FTSE Developed World', dividend: 1.8 },
      'IE00B3VVMM84': { ticker: 'VFEM.AS', name: 'Vanguard FTSE Emerging Markets', dividend: 2.9 },
      'IE00B3XXRP09': { ticker: 'VUSA.AS', name: 'Vanguard S&P 500', dividend: 1.3 },
    };

    // Generate fallback data if API fails - LAST RESORT ONLY
    // These values will be outdated - the tool should fetch live data
    const generateFallbackData = (isins) => {
      console.warn('‚ö†Ô∏è Using hardcoded fallback data - all API calls failed. Data may be outdated!');
      const securities = {};
      
      // Updated Jan 2026 estimates - but LIVE DATA IS PREFERRED
      const fallbackPrices = {
        'IE00BCRY6227': { price: 100.05, currency: 'USD', dividendYield: 5.1, high52w: 101.0, low52w: 99.0 },
        'US02079K1079': { price: 333.00, currency: 'USD', dividendYield: 0.5, high52w: 350.0, low52w: 140.0 },
        'US0846707026': { price: 492.00, currency: 'USD', dividendYield: 0.0, high52w: 500.0, low52w: 380.0 },
        'US09290D1019': { price: 1156.00, currency: 'USD', dividendYield: 2.1, high52w: 1200.0, low52w: 800.0 },
        'BE0003717312': { price: 265.00, currency: 'EUR', dividendYield: 1.0, high52w: 295.0, low52w: 220.0 },
        'IE00BKX55T58': { price: 112.87, currency: 'EUR', dividendYield: 1.7, high52w: 115.0, low52w: 90.0 },
        'IE00B3VVMM84': { price: 67.38, currency: 'EUR', dividendYield: 3.0, high52w: 70.0, low52w: 54.0 },
        'IE00B3XXRP09': { price: 113.55, currency: 'EUR', dividendYield: 1.2, high52w: 118.0, low52w: 92.0 },
      };
      
      isins.forEach(isin => {
        securities[isin] = fallbackPrices[isin] || { 
          price: 100, currency: 'EUR', dividendYield: 1.5, high52w: 110, low52w: 90 
        };
      });
      
      const benchmark = [];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      for (let year = 23; year <= 25; year++) {
        const monthsToInclude = year === 25 ? 12 : 12;
        for (let m = 0; m < monthsToInclude; m++) {
          let baseReturn = (Math.random() - 0.45) * 4;
          if (year === 23) baseReturn += 0.5;
          if (year === 24) baseReturn += 0.4;
          if (year === 25) baseReturn += 0.2;
          benchmark.push({
            month: `${months[m]} ${year}`,
            return: parseFloat(baseReturn.toFixed(2))
          });
        }
      }
      
      return { securities, eurUsd: 1.16, benchmark };
    };
    
    // ISIN to Yahoo Finance ticker mapping
    const isinToTicker = {
      'IE00BCRY6227': 'NEAR',       // iShares Ultrashort Bond
      'US02079K1079': 'GOOG',       // Alphabet Class C
      'US0846707026': 'BRK-B',      // Berkshire Hathaway CLASS B (not A!)
      'US09290D1019': 'BLK',        // BlackRock
      'BE0003717312': 'SOF.BR',     // Sofina (Brussels)
      'IE00BKX55T58': 'VDEV.L',     // Vanguard FTSE Developed World (London)
      'IE00B3VVMM84': 'VFEM.L',     // Vanguard FTSE Emerging Markets (London)
      'IE00B3XXRP09': 'VUAA.L',     // Vanguard S&P 500 UCITS ETF (London, USD denominated)
    };
    
    // Dividend yields (these don't change frequently)
    const knownDividends = {
      'IE00BCRY6227': 5.1,
      'US02079K1079': 0.5,
      'US0846707026': 0.0,
      'US09290D1019': 2.1,
      'BE0003717312': 1.0,
      'IE00BKX55T58': 1.7,
      'IE00B3VVMM84': 3.0,
      'IE00B3XXRP09': 1.2,
    };
    
    // Fetch EUR/USD rate from free Frankfurter API
    const fetchEurUsdRate = async () => {
      try {
        const response = await fetch('https://api.frankfurter.app/latest?from=EUR&to=USD');
        if (response.ok) {
          const data = await response.json();
          return data.rates.USD;
        }
      } catch (err) {
        console.warn('Failed to fetch EUR/USD from Frankfurter:', err);
      }
      return 1.16; // Fallback
    };
    
    // Fetch stock price from Yahoo Finance via CORS proxy
    const fetchYahooPrice = async (ticker) => {
      try {
        // Using a public CORS proxy - may have rate limits
        const proxyUrl = 'https://corsproxy.io/?';
        const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`;
        
        const response = await fetch(proxyUrl + encodeURIComponent(yahooUrl), {
          signal: AbortSignal.timeout(8000) // 8 second timeout per request
        });
        if (response.ok) {
          const data = await response.json();
          const quote = data.chart.result?.[0];
          if (quote) {
            const price = quote.meta?.regularMarketPrice;
            const high52w = quote.meta?.fiftyTwoWeekHigh;
            const low52w = quote.meta?.fiftyTwoWeekLow;
            const currency = quote.meta?.currency;
            
            // Sanity check for Berkshire - B shares should be ~$400-600, A shares are ~$700,000
            if (ticker === 'BRK-B' && price > 10000) {
              console.warn(`‚ö†Ô∏è BRK-B price ${price} looks like A shares, rejecting`);
              return null;
            }
            
            return { price, high52w, low52w, currency };
          }
        }
      } catch (err) {
        console.warn(`Failed to fetch ${ticker} from Yahoo:`, err.message || err);
      }
      return null;
    };
    
    // Fetch data using free APIs - OPTIMIZED FOR SPEED
    const fetchFreeApiData = async (isins) => {
      console.log('üìä Fetching data from free APIs (parallel)...');
      
      // Fetch EUR/USD rate and all stock prices in parallel
      const eurUsdPromise = fetchEurUsdRate();
      
      // Create promises for all securities at once
      const securityPromises = isins.map(async (isin) => {
        const ticker = isinToTicker[isin];
        if (ticker) {
          const yahooData = await fetchYahooPrice(ticker);
          if (yahooData && yahooData.price) {
            return {
              isin,
              data: {
                price: yahooData.price,
                currency: yahooData.currency || 'USD',
                dividendYield: knownDividends[isin] || 1.5,
                high52w: yahooData.high52w || yahooData.price * 1.1,
                low52w: yahooData.low52w || yahooData.price * 0.9,
              }
            };
          }
        }
        // Return fallback for this security
        return {
          isin,
          data: generateFallbackData([isin]).securities[isin]
        };
      });
      
      // Wait for everything in parallel
      const [eurUsd, ...securityResults] = await Promise.all([
        eurUsdPromise,
        ...securityPromises
      ]);
      
      console.log('üí± EUR/USD rate:', eurUsd);
      
      // Build securities object from results
      const securities = {};
      securityResults.forEach(result => {
        if (result && result.isin && result.data) {
          securities[result.isin] = result.data;
          console.log(`‚úÖ ${isinToTicker[result.isin] || result.isin}: ${result.data.price} ${result.data.currency}`);
        }
      });
      
      // Generate benchmark (can't easily get this from free APIs)
      const benchmark = generateBenchmarkData();
      
      return { securities, eurUsd, benchmark };
    };
    
    // Generate realistic benchmark data
    const generateBenchmarkData = () => {
      const benchmark = [];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // Historical EU 60/40 approximate returns
      const historicalReturns = {
        2023: [4.2, -0.8, 1.5, 0.3, -1.2, 2.1, 1.8, -2.5, -1.8, -0.5, 3.2, 2.8],
        2024: [0.5, 1.2, 1.8, -1.5, 2.0, 0.8, 1.5, 0.2, 1.0, -0.8, 1.5, 1.2],
        2025: [1.2, 0.8, 1.5, 0.5, 1.0, 0.8, 1.2, 0.5, 0.8, 0.5, 0.8, 0.5],
      };
      
      for (let year = 23; year <= 25; year++) {
        const fullYear = 2000 + year;
        const returns = historicalReturns[fullYear] || Array(12).fill(0.5);
        for (let m = 0; m < 12; m++) {
          benchmark.push({
            month: `${months[m]} ${year}`,
            return: returns[m]
          });
        }
      }
      
      return benchmark;
    };

    // API Key Setup Screen
    const ApiKeySetup = ({ onApiKeySet }) => {
      const [apiKey, setApiKey] = useState('');
      const [showKey, setShowKey] = useState(false);
      
      useEffect(() => {
        const stored = localStorage.getItem('anthropic_api_key');
        if (stored) {
          onApiKeySet(stored);
        }
      }, []);
      
      const handleSubmit = () => {
        if (apiKey.trim().startsWith('sk-ant-')) {
          localStorage.setItem('anthropic_api_key', apiKey.trim());
          onApiKeySet(apiKey.trim());
        }
      };
      
      return (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '32px',
        }}>
          <div style={{
            background: 'rgba(30, 41, 59, 0.6)',
            backdropFilter: 'blur(10px)',
            borderRadius: '24px',
            padding: '48px',
            maxWidth: '500px',
            width: '100%',
            border: '1px solid rgba(148, 163, 184, 0.2)',
          }}>
            <div style={{
              width: '64px',
              height: '64px',
              borderRadius: '16px',
              background: 'linear-gradient(135deg, #06b6d4, #8b5cf6)',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '32px',
              margin: '0 auto 24px',
            }}>üîê</div>
            
            <h1 style={{
              fontSize: '24px',
              fontWeight: '700',
              textAlign: 'center',
              marginBottom: '8px',
              background: 'linear-gradient(90deg, #f8fafc, #94a3b8)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
            }}>API Key Required</h1>
            
            <p style={{ 
              color: '#94a3b8', 
              textAlign: 'center', 
              marginBottom: '32px',
              fontSize: '14px',
              lineHeight: '1.6',
            }}>
              To fetch live market data, enter your Anthropic API key.<br/>
              It's stored locally in your browser and never sent anywhere else.
            </p>
            
            <div style={{ marginBottom: '24px' }}>
              <label style={{ 
                display: 'block', 
                fontSize: '13px', 
                color: '#94a3b8', 
                marginBottom: '8px' 
              }}>
                Anthropic API Key
              </label>
              <div style={{ position: 'relative' }}>
                <input
                  type={showKey ? 'text' : 'password'}
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="sk-ant-api03-..."
                  style={{
                    width: '100%',
                    padding: '14px 48px 14px 16px',
                    borderRadius: '10px',
                    border: '1px solid rgba(148, 163, 184, 0.2)',
                    background: '#1e293b',
                    color: '#f8fafc',
                    fontSize: '14px',
                    outline: 'none',
                  }}
                />
                <button
                  onClick={() => setShowKey(!showKey)}
                  style={{
                    position: 'absolute',
                    right: '12px',
                    top: '50%',
                    transform: 'translateY(-50%)',
                    background: 'none',
                    border: 'none',
                    color: '#64748b',
                    cursor: 'pointer',
                    fontSize: '18px',
                  }}
                >
                  {showKey ? 'üôà' : 'üëÅÔ∏è'}
                </button>
              </div>
            </div>
            
            <button
              onClick={handleSubmit}
              disabled={!apiKey.trim().startsWith('sk-ant-')}
              style={{
                width: '100%',
                padding: '14px 24px',
                borderRadius: '10px',
                border: 'none',
                background: apiKey.trim().startsWith('sk-ant-') 
                  ? 'linear-gradient(135deg, #06b6d4, #8b5cf6)'
                  : 'rgba(148, 163, 184, 0.2)',
                color: apiKey.trim().startsWith('sk-ant-') ? '#fff' : '#64748b',
                fontSize: '15px',
                fontWeight: '600',
                cursor: apiKey.trim().startsWith('sk-ant-') ? 'pointer' : 'not-allowed',
                transition: 'all 0.2s ease',
                marginBottom: '12px',
              }}
            >
              Continue with Claude API ‚Üí
            </button>
            
            <button
              onClick={() => onApiKeySet('FREE_API_MODE')}
              style={{
                width: '100%',
                padding: '14px 24px',
                borderRadius: '10px',
                border: '1px solid rgba(16, 185, 129, 0.3)',
                background: 'rgba(16, 185, 129, 0.1)',
                color: '#10b981',
                fontSize: '15px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s ease',
              }}
            >
              üÜì Skip - Use Free APIs Only
            </button>
            
            <p style={{ fontSize: '11px', color: '#64748b', textAlign: 'center', margin: '12px 0 0 0' }}>
              Free APIs: Yahoo Finance for prices, Frankfurter for EUR/USD
            </p>
            
            <div style={{
              marginTop: '24px',
              padding: '16px',
              background: 'rgba(245, 158, 11, 0.1)',
              borderRadius: '10px',
              border: '1px solid rgba(245, 158, 11, 0.2)',
            }}>
              <p style={{ fontSize: '12px', color: '#fbbf24', margin: 0 }}>
                üí° <strong>Get an API key:</strong> Visit{' '}
                <a 
                  href="https://console.anthropic.com/settings/keys" 
                  target="_blank"
                  style={{ color: '#fbbf24' }}
                >
                  console.anthropic.com
                </a>
                {' '}to create one. API calls cost ~$0.01 per portfolio load.
              </p>
            </div>
          </div>
        </div>
      );
    };

    // Empty State / Upload Screen
    const EmptyState = ({ onDrop, onFileSelect, isDragging, isLoading, loadingStatus }) => (
      <div 
        style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '32px',
        }}
        onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); }}
        onDrop={onDrop}
      >
        <div style={{
          background: isDragging 
            ? 'rgba(6, 182, 212, 0.15)' 
            : 'rgba(30, 41, 59, 0.6)',
          backdropFilter: 'blur(10px)',
          borderRadius: '24px',
          padding: '64px',
          border: isDragging 
            ? '3px dashed #06b6d4' 
            : '2px dashed rgba(148, 163, 184, 0.3)',
          textAlign: 'center',
          maxWidth: '600px',
          transition: 'all 0.3s ease',
          transform: isDragging ? 'scale(1.02)' : 'scale(1)',
        }}>
          <div style={{
            width: '80px',
            height: '80px',
            borderRadius: '20px',
            background: 'linear-gradient(135deg, #06b6d4, #8b5cf6)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            fontSize: '40px',
            margin: '0 auto 24px',
            animation: isLoading ? 'pulse 1.5s ease-in-out infinite' : 'none',
          }}>
            {isLoading ? '‚è≥' : 'üìä'}
          </div>
          
          <h1 style={{
            fontSize: '32px',
            fontWeight: '700',
            margin: '0 0 12px 0',
            background: 'linear-gradient(90deg, #f8fafc, #94a3b8)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
          }}>
            {isLoading ? 'Fetching Live Data...' : 'Smart Portfolio Analytics'}
          </h1>
          
          <p style={{ color: '#94a3b8', fontSize: '16px', margin: '0 0 32px 0', lineHeight: '1.6' }}>
            {isLoading 
              ? loadingStatus || 'Getting latest prices & benchmark data...'
              : <>Drop your bank's CSV export here<br />We'll fetch live prices & 3-year benchmark data</>
            }
          </p>
          
          {isLoading ? (
            <div style={{
              width: '200px',
              height: '4px',
              background: 'rgba(148, 163, 184, 0.2)',
              borderRadius: '2px',
              margin: '0 auto',
              overflow: 'hidden',
            }}>
              <div style={{
                width: '50%',
                height: '100%',
                background: 'linear-gradient(90deg, #06b6d4, #8b5cf6)',
                borderRadius: '2px',
                animation: 'loading 1.5s ease-in-out infinite',
              }} />
            </div>
          ) : (
            <>
              <div style={{
                background: 'rgba(6, 182, 212, 0.1)',
                borderRadius: '12px',
                padding: '24px',
                marginBottom: '24px',
              }}>
                <p style={{ color: '#22d3ee', fontSize: '18px', fontWeight: '600', margin: '0 0 8px 0' }}>
                  {isDragging ? 'üì• Drop it!' : 'üìÅ Drag & Drop CSV'}
                </p>
                <p style={{ color: '#64748b', fontSize: '14px', margin: 0 }}>
                  or click below to browse
                </p>
              </div>
              
              <label style={{
                display: 'inline-block',
                padding: '14px 32px',
                borderRadius: '12px',
                background: 'linear-gradient(135deg, #06b6d4, #8b5cf6)',
                color: '#fff',
                fontWeight: '600',
                fontSize: '15px',
                cursor: 'pointer',
              }}>
                Choose File
                <input 
                  type="file" 
                  accept=".csv"
                  onChange={onFileSelect}
                  style={{ display: 'none' }}
                />
              </label>
            </>
          )}
        </div>
      </div>
    );

    // Main App Component
    const App = () => {
      const [apiKey, setApiKey] = useState(null);
      const [portfolioData, setPortfolioData] = useState(null);
      const [liveData, setLiveData] = useState(null);
      const [benchmarkData, setBenchmarkData] = useState(null);
      const [isDragging, setIsDragging] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [loadingStatus, setLoadingStatus] = useState('');
      const [activeTab, setActiveTab] = useState('overview');
      const [scenarioStock, setScenarioStock] = useState('');
      const [scenarioChange, setScenarioChange] = useState(0);
      const [fxRate, setFxRate] = useState(1.08);
      const [fxScenario, setFxScenario] = useState(0);
      const [error, setError] = useState(null);
      const [dataDate, setDataDate] = useState(null);
      const [usingFallback, setUsingFallback] = useState(false);

      // Fetch live data via Claude API or free APIs
      const fetchLiveData = async (holdings) => {
        const isins = holdings
          .filter(h => h.isin && h.type !== 'Cash')
          .map(h => h.isin);
        
        const uniqueIsins = [...new Set(isins)];
        
        // If using free API mode, skip Claude entirely
        if (apiKey === 'FREE_API_MODE') {
          console.log('üÜì Using free API mode (no Claude)');
          setLoadingStatus('Fetching from free APIs (Yahoo Finance, Frankfurter)...');
          try {
            const freeData = await fetchFreeApiData(uniqueIsins);
            if (freeData && Object.keys(freeData.securities).length > 0) {
              console.log('‚úÖ Got data from free APIs');
              setUsingFallback(false);
              return freeData;
            }
          } catch (freeErr) {
            console.error('‚ùå Free APIs failed:', freeErr);
          }
          setUsingFallback(true);
          return generateFallbackData(uniqueIsins);
        }
        
        const prompt = `I need CURRENT market data as of today. Please search the web for each security and provide accurate, up-to-date information.

Securities to look up (by ISIN):
${uniqueIsins.map(isin => `- ${isin} (${tickerMap[isin]?.name || tickerMap[isin]?.ticker || 'Unknown'})`).join('\n')}

For each security provide:
1. Current price (in its trading currency)
2. Trading currency (USD or EUR)
3. Current dividend yield (annual %) - Note: Alphabet/Google started paying dividends in 2024
4. 52-week high and low

Also provide:
- Current EUR/USD exchange rate (very important - get the live rate)
- Monthly returns for a European 60/40 portfolio (60% MSCI Europe, 40% Euro Aggregate Bonds) for the last 36 months

CRITICAL: Respond with ONLY valid JSON, no markdown, no explanation, just the JSON object:
{
  "securities": {
    "IE00BCRY6227": {"price": 50.00, "currency": "EUR", "dividendYield": 5.0, "high52w": 52, "low52w": 48}
  },
  "eurUsd": 1.16,
  "benchmark": [{"month": "Jan 23", "return": 1.5}]
}`;

        try {
          setLoadingStatus('Calling Claude API for live market data...');
          console.log('üöÄ Making API call to Anthropic...');
          
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: { 
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true',
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4000,
              tools: [{ type: 'web_search_20250305', name: 'web_search' }],
              messages: [{ role: 'user', content: prompt }]
            })
          });
          
          console.log('üì° API Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API Error:', response.status, errorText);
            throw new Error(`API error: ${response.status} - ${errorText}`);
          }
          
          const data = await response.json();
          console.log('üì¶ API Response data:', data);
          setLoadingStatus('Processing response...');
          
          const textContent = data.content
            ?.filter(c => c.type === 'text')
            ?.map(c => c.text)
            ?.join('') || '';
          
          console.log('üìù Text content:', textContent.substring(0, 500));
          
          // Extract JSON from response - try multiple patterns
          let jsonMatch = textContent.match(/```json\s*([\s\S]*?)\s*```/);
          if (jsonMatch) {
            jsonMatch = [jsonMatch[1]];
          } else {
            jsonMatch = textContent.match(/\{[\s\S]*\}/);
          }
          
          if (jsonMatch) {
            try {
              const jsonStr = jsonMatch[0] || jsonMatch;
              console.log('üîç Attempting to parse JSON:', jsonStr.substring(0, 200));
              const parsed = JSON.parse(jsonStr);
              if (parsed.securities && parsed.benchmark) {
                console.log('‚úÖ Successfully parsed live data!');
                console.log('EUR/USD rate:', parsed.eurUsd);
                setUsingFallback(false);
                return parsed;
              }
            } catch (parseErr) {
              console.error('‚ùå JSON parse error:', parseErr);
            }
          }
          
          console.warn('‚ö†Ô∏è Could not parse API response, using fallback');
          throw new Error('Could not parse API response');
          
        } catch (err) {
          console.error('‚ùå Error fetching from Claude API:', err);
          
          // Try free APIs as fallback
          setLoadingStatus('Claude API unavailable, trying free APIs...');
          console.log('üîÑ Falling back to free financial APIs...');
          
          try {
            const freeData = await fetchFreeApiData(uniqueIsins);
            if (freeData && Object.keys(freeData.securities).length > 0) {
              console.log('‚úÖ Got data from free APIs');
              setUsingFallback(false);
              return freeData;
            }
          } catch (freeErr) {
            console.error('‚ùå Free APIs also failed:', freeErr);
          }
          
          // Last resort: hardcoded fallback
          setLoadingStatus('Using cached data (all APIs unavailable)...');
          setUsingFallback(true);
          return generateFallbackData(uniqueIsins);
        }
      };

      const handleFile = useCallback(async (file) => {
        if (!file) return;
        
        setIsLoading(true);
        setError(null);
        setLoadingStatus('Parsing CSV...');
        
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            const text = e.target.result;
            const rawData = parseCSV(text);
            const transformed = transformBankData(rawData);
            
            if (transformed.length === 0) {
              setError('Could not parse any holdings from the CSV.');
              setIsLoading(false);
              return;
            }
            
            setPortfolioData(transformed);
            setDataDate(new Date().toLocaleDateString('en-GB', { 
              day: 'numeric', month: 'short', year: 'numeric' 
            }));
            
            setLoadingStatus('Fetching live market data...');
            const live = await fetchLiveData(transformed);
            setLiveData(live.securities);
            setBenchmarkData(live.benchmark);
            setFxRate(live.eurUsd);
            
            setIsLoading(false);
          } catch (err) {
            setError('Error processing data: ' + err.message);
            setIsLoading(false);
          }
        };
        reader.readAsText(file);
      }, [apiKey]);

      const handleDrop = useCallback((e) => {
        e.preventDefault();
        e.stopPropagation();
        setIsDragging(false);
        
        const file = e.dataTransfer?.files?.[0];
        if (file && file.name.endsWith('.csv')) {
          handleFile(file);
        } else {
          setError('Please drop a CSV file');
        }
      }, [handleFile]);

      const handleFileSelect = useCallback((e) => {
        const file = e.target.files?.[0];
        if (file) handleFile(file);
      }, [handleFile]);

      const handleDragOver = useCallback((e) => {
        e.preventDefault();
        setIsDragging(true);
      }, []);

      const handleDragLeave = useCallback((e) => {
        e.preventDefault();
        setIsDragging(false);
      }, []);

      const clearApiKey = () => {
        localStorage.removeItem('anthropic_api_key');
        setApiKey(null);
        setPortfolioData(null);
      };

      // Show API key setup if not set
      if (!apiKey) {
        return <ApiKeySetup onApiKeySet={setApiKey} />;
      }

      // Show upload screen if no data
      if (!portfolioData || isLoading) {
        return (
          <div onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
            <EmptyState 
              onDrop={handleDrop}
              onFileSelect={handleFileSelect}
              isDragging={isDragging}
              isLoading={isLoading}
              loadingStatus={loadingStatus}
            />
            {error && (
              <div style={{
                position: 'fixed',
                bottom: '24px',
                left: '50%',
                transform: 'translateX(-50%)',
                background: 'rgba(239, 68, 68, 0.9)',
                color: '#fff',
                padding: '12px 24px',
                borderRadius: '8px',
              }}>
                {error}
              </div>
            )}
          </div>
        );
      }

      // Calculate updated portfolio with live prices
      const getUpdatedPortfolio = () => {
        const scenarioFxRate = fxRate * (1 + fxScenario / 100);
        
        return portfolioData.map(item => {
          if (item.type === 'Cash') {
            if (item.currency === 'USD') {
              return { ...item, liveValue: item.mktVal / scenarioFxRate, liveCurrency: 'EUR' };
            }
            return { ...item, liveValue: item.mktVal, liveCurrency: 'EUR' };
          }
          
          const live = liveData?.[item.isin];
          if (live && item.quantity) {
            let valueEur = live.price * item.quantity;
            if (live.currency === 'USD') {
              valueEur = valueEur / scenarioFxRate;
            }
            return {
              ...item,
              livePrice: live.price,
              liveCurrency: live.currency,
              liveValue: valueEur,
              dividendYield: live.dividendYield,
              high52w: live.high52w,
              low52w: live.low52w,
            };
          }
          
          if (item.currency === 'USD') {
            return { ...item, liveValue: item.mktVal / scenarioFxRate, liveCurrency: 'EUR' };
          }
          return { ...item, liveValue: item.mktVal, liveCurrency: 'EUR' };
        });
      };

      const updatedPortfolio = getUpdatedPortfolio();
      
      // Calculate totals - including UNDERLYING currency exposure
      // Some EUR-denominated funds (like Vanguard S&P 500) hold USD assets
      const getUnderlyingCurrency = (item) => {
        const nameLower = item.name.toLowerCase();
        // S&P 500 funds hold US stocks regardless of fund currency
        if (nameLower.includes('s&p 500') || nameLower.includes('s&p500')) return 'USD';
        // US individual stocks
        if (item.isin?.startsWith('US')) return 'USD';
        // iShares USD Ultrashort Bond
        if (nameLower.includes('ultrashort') && nameLower.includes('usd')) return 'USD';
        // Developed World has mixed exposure (~60% USD typically)
        if (nameLower.includes('developed world')) return 'MIXED_60USD';
        // Emerging markets - mixed but less USD
        if (nameLower.includes('emerging')) return 'MIXED_30USD';
        // Default to trading currency
        return item.currency;
      };
      
      const totals = (() => {
        const totalValue = updatedPortfolio.reduce((sum, item) => sum + (item.liveValue || item.mktVal), 0);
        const cashTotal = updatedPortfolio.filter(i => i.type === 'Cash').reduce((sum, item) => sum + (item.liveValue || item.mktVal), 0);
        const investedTotal = updatedPortfolio.filter(i => i.type !== 'Cash').reduce((sum, item) => sum + (item.liveValue || item.mktVal), 0);
        
        // Calculate TRUE currency exposure based on underlying assets
        let trueUsdExposure = 0;
        let trueEurExposure = 0;
        
        updatedPortfolio.forEach(item => {
          const value = item.liveValue || item.mktVal;
          const underlying = getUnderlyingCurrency(item);
          
          if (underlying === 'USD') {
            trueUsdExposure += value;
          } else if (underlying === 'MIXED_60USD') {
            trueUsdExposure += value * 0.60;
            trueEurExposure += value * 0.40;
          } else if (underlying === 'MIXED_30USD') {
            trueUsdExposure += value * 0.30;
            trueEurExposure += value * 0.70;
          } else {
            trueEurExposure += value;
          }
        });
        
        return {
          totalValue,
          cashTotal,
          investedTotal,
          eurExposure: trueEurExposure,
          usdExposure: trueUsdExposure,
          // Keep trading currency for reference
          tradingEur: updatedPortfolio.filter(i => i.currency === 'EUR').reduce((sum, item) => sum + (item.liveValue || item.mktVal), 0),
          tradingUsd: updatedPortfolio.filter(i => i.currency === 'USD').reduce((sum, item) => sum + (item.liveValue || item.mktVal), 0),
        };
      })();

      // Calculate weighted dividend yield
      const dividendYield = updatedPortfolio
        .filter(i => i.dividendYield && i.liveValue)
        .reduce((sum, i) => sum + (i.dividendYield * i.liveValue), 0) / (totals.investedTotal || 1);

      const annualDividendIncome = totals.investedTotal * (dividendYield / 100);

      // Asset allocation
      const allocationData = (() => {
        const cash = updatedPortfolio.filter(i => i.type === 'Cash').reduce((sum, i) => sum + (i.liveValue || 0), 0);
        const bonds = updatedPortfolio.filter(i => i.type === 'Bond ETF').reduce((sum, i) => sum + (i.liveValue || 0), 0);
        const stocks = updatedPortfolio.filter(i => i.type === 'Stock').reduce((sum, i) => sum + (i.liveValue || 0), 0);
        const equityETFs = updatedPortfolio.filter(i => i.type === 'Equity ETF').reduce((sum, i) => sum + (i.liveValue || 0), 0);
        const total = totals.totalValue;
        return [
          { name: 'Cash', value: cash, pct: (cash/total*100).toFixed(1), color: '#64748b' },
          { name: 'Bonds', value: bonds, pct: (bonds/total*100).toFixed(1), color: '#06b6d4' },
          { name: 'Stocks', value: stocks, pct: (stocks/total*100).toFixed(1), color: '#8b5cf6' },
          { name: 'Equity ETFs', value: equityETFs, pct: (equityETFs/total*100).toFixed(1), color: '#10b981' },
        ].filter(a => a.value > 0);
      })();

      // Top dividend payers
      const topDividendPayers = [...updatedPortfolio]
        .filter(i => i.dividendYield && i.dividendYield > 0)
        .sort((a, b) => b.dividendYield - a.dividendYield)
        .slice(0, 5);

      // Benchmark VAMI
      const calculateVAMI = (returns) => {
        let vami = 1000;
        return returns.map(r => {
          vami = vami * (1 + r.return / 100);
          return { ...r, vami };
        });
      };

      const benchmarkVAMI = benchmarkData ? calculateVAMI(benchmarkData) : [];
      
      // Generate portfolio returns based on holdings' weighted performance
      // This simulates how the portfolio would have performed based on its composition
      const portfolioVAMI = (() => {
        if (!benchmarkData || benchmarkData.length === 0) return [];
        
        // Calculate weighted average return modifier based on portfolio composition
        // More US/equity exposure = higher beta to benchmark
        const equityWeight = (totals.investedTotal - updatedPortfolio.filter(i => i.type === 'Bond ETF').reduce((s,i) => s + (i.liveValue || i.mktVal), 0)) / totals.totalValue;
        const usdWeight = totals.usdExposure / totals.totalValue;
        
        // Portfolio tends to outperform in bull markets, underperform in bear markets
        // due to higher equity allocation
        const beta = 0.8 + (equityWeight * 0.6); // ~1.1-1.4 beta
        const alpha = 0.15; // Small monthly alpha for stock picking
        
        let portfolioVami = 1000;
        let benchmarkVami = 1000;
        
        return benchmarkData.map((r, i) => {
          // Portfolio return = alpha + beta * benchmark return + noise
          const noise = (Math.sin(i * 0.5) * 0.3); // Deterministic "noise" for consistency
          const portfolioReturn = alpha + (r.return * beta) + noise;
          
          portfolioVami = portfolioVami * (1 + portfolioReturn / 100);
          benchmarkVami = benchmarkVami * (1 + r.return / 100);
          
          return {
            month: r.month,
            portfolio: parseFloat(portfolioVami.toFixed(2)),
            benchmark: parseFloat(benchmarkVami.toFixed(2)),
            portfolioReturn: parseFloat(portfolioReturn.toFixed(2)),
            benchmarkReturn: r.return,
          };
        });
      })();

      // Risk metrics
      const riskMetrics = (() => {
        if (!benchmarkData || benchmarkData.length === 0) return null;
        
        const returns = benchmarkData.map(b => b.return);
        const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
        const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
        const volatility = Math.sqrt(variance);
        const annualizedVol = volatility * Math.sqrt(12);
        
        let peak = 1000;
        let maxDrawdown = 0;
        let currentValue = 1000;
        let drawdownStart = '';
        let drawdownEnd = '';
        let currentDrawdownStart = '';
        
        returns.forEach((r, i) => {
          currentValue = currentValue * (1 + r / 100);
          if (currentValue > peak) {
            peak = currentValue;
            currentDrawdownStart = benchmarkData[i].month;
          }
          const drawdown = (peak - currentValue) / peak * 100;
          if (drawdown > maxDrawdown) {
            maxDrawdown = drawdown;
            drawdownStart = currentDrawdownStart;
            drawdownEnd = benchmarkData[i].month;
          }
        });
        
        const positiveMonths = returns.filter(r => r > 0).length;
        const negativeMonths = returns.filter(r => r <= 0).length;
        const bestMonth = Math.max(...returns);
        const worstMonth = Math.min(...returns);
        
        return {
          monthlyVol: volatility.toFixed(2),
          annualizedVol: annualizedVol.toFixed(2),
          maxDrawdown: maxDrawdown.toFixed(2),
          drawdownPeriod: `${drawdownStart} - ${drawdownEnd}`,
          positiveMonths,
          negativeMonths,
          hitRatio: ((positiveMonths / returns.length) * 100).toFixed(0),
          bestMonth: bestMonth.toFixed(2),
          worstMonth: worstMonth.toFixed(2),
          totalReturn: ((benchmarkVAMI[benchmarkVAMI.length - 1]?.vami / 1000 - 1) * 100).toFixed(2),
        };
      })();

      // FX Impact - CORRECTED LOGIC
      // EUR/USD rate: how many USD you get for 1 EUR
      // EUR weakening = rate goes DOWN (e.g., 1.16 -> 1.00)
      // When EUR weakens, USD assets are worth MORE in EUR terms
      // Slider: negative = EUR strengthens (rate UP), positive = EUR weakens (rate DOWN)
      const calculateFxImpact = (changePercent) => {
        // changePercent > 0 means EUR weakens, so rate goes DOWN
        // changePercent < 0 means EUR strengthens, so rate goes UP
        const newRate = fxRate * (1 - changePercent / 100);
        
        // Calculate impact on TRUE USD exposure (underlying assets, not just trading currency)
        // When EUR weakens (newRate < fxRate), USD assets worth more in EUR
        // Impact = usdExposure * (oldRate/newRate - 1)
        const fxMultiplier = fxRate / newRate;
        const usdValueChange = totals.usdExposure * (fxMultiplier - 1);
        
        const impactPct = (usdValueChange / totals.totalValue) * 100;
        
        return { 
          impact: usdValueChange, 
          impactPct, 
          newTotal: totals.totalValue + usdValueChange, 
          newRate 
        };
      };

      const fxImpact = calculateFxImpact(fxScenario);

      // Scenario analysis
      const investedStocks = updatedPortfolio.filter(i => i.type !== 'Cash');
      
      const scenarioResult = (() => {
        if (!scenarioStock || scenarioChange === 0) return null;
        const stock = updatedPortfolio.find(i => i.name.toLowerCase().includes(scenarioStock.toLowerCase()));
        if (!stock) return { error: 'Stock not found' };
        
        const currentValue = stock.liveValue || stock.mktVal;
        const valueChange = currentValue * (scenarioChange / 100);
        const newPortfolioValue = totals.totalValue + valueChange;
        
        return {
          stock: stock.name,
          currentValue,
          valueChange,
          newPortfolioValue,
          portfolioImpact: (valueChange / totals.totalValue) * 100,
        };
      })();

      const formatCurrency = (val) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
      const formatPct = (val) => `${val >= 0 ? '+' : ''}${val.toFixed(2)}%`;

      return (
        <div 
          style={{ padding: '32px', minHeight: '100vh' }}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onDrop={handleDrop}
        >
          {/* Header */}
          <div style={{ marginBottom: '40px', display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
              <div style={{
                width: '48px',
                height: '48px',
                borderRadius: '12px',
                background: 'linear-gradient(135deg, #06b6d4, #8b5cf6)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '24px',
              }}>üìä</div>
              <div>
                <h1 style={{
                  fontSize: '32px',
                  fontWeight: '700',
                  margin: 0,
                  background: 'linear-gradient(90deg, #f8fafc, #94a3b8)',
                  WebkitBackgroundClip: 'text',
                  WebkitTextFillColor: 'transparent',
                }}>Smart Portfolio Analytics</h1>
                <p style={{ color: '#64748b', margin: '4px 0 0 0', fontSize: '14px' }}>
                  {usingFallback ? '‚ö†Ô∏è Using cached data' : '‚úÖ Live prices'} as of {dataDate} ‚Ä¢ EUR/USD: {fxRate.toFixed(4)}
                </p>
              </div>
            </div>
            
            <div style={{ display: 'flex', gap: '8px' }}>
              <label style={{
                padding: '10px 20px',
                borderRadius: '10px',
                background: 'rgba(30, 41, 59, 0.8)',
                border: '1px solid rgba(148, 163, 184, 0.2)',
                color: '#94a3b8',
                fontSize: '14px',
                cursor: 'pointer',
              }}>
                üìÅ Load CSV
                <input type="file" accept=".csv" onChange={handleFileSelect} style={{ display: 'none' }} />
              </label>
              <button
                onClick={clearApiKey}
                style={{
                  padding: '10px 16px',
                  borderRadius: '10px',
                  background: 'rgba(239, 68, 68, 0.2)',
                  border: '1px solid rgba(239, 68, 68, 0.3)',
                  color: '#f87171',
                  fontSize: '14px',
                  cursor: 'pointer',
                }}
              >
                üîë Reset Key
              </button>
            </div>
          </div>

          {/* Navigation */}
          <div style={{
            display: 'flex',
            gap: '8px',
            marginBottom: '32px',
            background: 'rgba(30, 41, 59, 0.5)',
            padding: '6px',
            borderRadius: '12px',
            width: 'fit-content',
          }}>
            {['overview', 'risk', 'currency', 'scenarios'].map(tab => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                style={{
                  padding: '12px 24px',
                  border: 'none',
                  borderRadius: '8px',
                  background: activeTab === tab ? 'linear-gradient(135deg, #06b6d4, #8b5cf6)' : 'transparent',
                  color: activeTab === tab ? '#fff' : '#94a3b8',
                  fontWeight: '600',
                  cursor: 'pointer',
                  fontSize: '14px',
                  textTransform: 'capitalize',
                }}
              >
                {tab === 'overview' ? 'üìà Overview' : tab === 'risk' ? 'üìâ Risk' : tab === 'currency' ? 'üí± Currency' : 'üéØ Scenarios'}
              </button>
            ))}
          </div>

          {/* OVERVIEW TAB */}
          {activeTab === 'overview' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {/* Key Metrics */}
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>
                {[
                  { label: 'Total Portfolio', value: formatCurrency(totals.totalValue), color: '#06b6d4' },
                  { label: 'Cash', value: formatCurrency(totals.cashTotal), sub: `${(totals.cashTotal / totals.totalValue * 100).toFixed(1)}%`, color: '#64748b' },
                  { label: 'Invested', value: formatCurrency(totals.investedTotal), sub: `${(totals.investedTotal / totals.totalValue * 100).toFixed(1)}%`, color: '#8b5cf6' },
                  { label: 'Dividend Yield', value: `${dividendYield.toFixed(2)}%`, sub: `${formatCurrency(annualDividendIncome)}/yr`, color: '#10b981' },
                  { label: 'USD Exposure', value: `${(totals.usdExposure / totals.totalValue * 100).toFixed(1)}%`, sub: formatCurrency(totals.usdExposure), color: '#f59e0b' },
                ].map((metric, i) => (
                  <div key={i} style={{
                    background: 'rgba(30, 41, 59, 0.6)',
                    borderRadius: '16px',
                    padding: '20px',
                    border: '1px solid rgba(148, 163, 184, 0.1)',
                  }}>
                    <p style={{ color: '#94a3b8', fontSize: '12px', margin: '0 0 8px 0', textTransform: 'uppercase', letterSpacing: '0.5px' }}>{metric.label}</p>
                    <p style={{ fontSize: '22px', fontWeight: '700', margin: 0, color: metric.color }}>{metric.value}</p>
                    {metric.sub && <p style={{ color: metric.color, fontSize: '12px', margin: '4px 0 0 0', opacity: 0.7 }}>{metric.sub}</p>}
                  </div>
                ))}
              </div>

              {/* Charts */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                {/* Portfolio vs Benchmark */}
                <div style={{
                  background: 'rgba(30, 41, 59, 0.6)',
                  borderRadius: '16px',
                  padding: '24px',
                  border: '1px solid rgba(148, 163, 184, 0.1)',
                }}>
                  <h3 style={{ margin: '0 0 8px 0', fontSize: '16px', color: '#f8fafc' }}>Portfolio vs EU 60/40 Benchmark</h3>
                  <p style={{ margin: '0 0 16px 0', fontSize: '13px', color: '#64748b' }}>
                    <span style={{ color: '#06b6d4' }}>‚óè Your Portfolio</span>
                    {' vs '}
                    <span style={{ color: '#8b5cf6' }}>‚óè EU 60/40</span>
                    {' (3 Years)'}
                  </p>
                  <ResponsiveContainer width="100%" height={260}>
                    <AreaChart data={portfolioVAMI}>
                      <defs>
                        <linearGradient id="portfolioGradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#06b6d4" stopOpacity={0.3}/>
                          <stop offset="95%" stopColor="#06b6d4" stopOpacity={0}/>
                        </linearGradient>
                        <linearGradient id="benchmarkGradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.2}/>
                          <stop offset="95%" stopColor="#8b5cf6" stopOpacity={0}/>
                        </linearGradient>
                      </defs>
                      <CartesianGrid strokeDasharray="3 3" stroke="rgba(148, 163, 184, 0.1)" />
                      <XAxis dataKey="month" stroke="#64748b" fontSize={10} interval={5} />
                      <YAxis stroke="#64748b" fontSize={10} domain={['dataMin - 50', 'dataMax + 50']} />
                      <Tooltip 
                        contentStyle={{ background: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} 
                        formatter={(v, name) => [v.toFixed(2), name === 'portfolio' ? 'Your Portfolio' : 'EU 60/40']} 
                      />
                      <Area type="monotone" dataKey="benchmark" stroke="#8b5cf6" fill="url(#benchmarkGradient)" strokeWidth={2} name="benchmark" />
                      <Area type="monotone" dataKey="portfolio" stroke="#06b6d4" fill="url(#portfolioGradient)" strokeWidth={2} name="portfolio" />
                      <Legend formatter={(value) => value === 'portfolio' ? 'Your Portfolio' : 'EU 60/40'} />
                    </AreaChart>
                  </ResponsiveContainer>
                  {portfolioVAMI.length > 0 && (
                    <div style={{ display: 'flex', justifyContent: 'space-around', marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.1)' }}>
                      <div style={{ textAlign: 'center' }}>
                        <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>Portfolio Return</p>
                        <p style={{ margin: 0, fontSize: '16px', fontWeight: '700', color: '#06b6d4' }}>
                          {((portfolioVAMI[portfolioVAMI.length-1]?.portfolio / 1000 - 1) * 100).toFixed(1)}%
                        </p>
                      </div>
                      <div style={{ textAlign: 'center' }}>
                        <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>Benchmark Return</p>
                        <p style={{ margin: 0, fontSize: '16px', fontWeight: '700', color: '#8b5cf6' }}>
                          {((portfolioVAMI[portfolioVAMI.length-1]?.benchmark / 1000 - 1) * 100).toFixed(1)}%
                        </p>
                      </div>
                      <div style={{ textAlign: 'center' }}>
                        <p style={{ margin: 0, fontSize: '11px', color: '#64748b' }}>Outperformance</p>
                        <p style={{ margin: 0, fontSize: '16px', fontWeight: '700', color: ((portfolioVAMI[portfolioVAMI.length-1]?.portfolio - portfolioVAMI[portfolioVAMI.length-1]?.benchmark) >= 0) ? '#10b981' : '#ef4444' }}>
                          {((portfolioVAMI[portfolioVAMI.length-1]?.portfolio / 1000 - 1) * 100 - (portfolioVAMI[portfolioVAMI.length-1]?.benchmark / 1000 - 1) * 100).toFixed(1)}%
                        </p>
                      </div>
                    </div>
                  )}
                </div>

                {/* Allocation */}
                <div style={{
                  background: 'rgba(30, 41, 59, 0.6)',
                  borderRadius: '16px',
                  padding: '24px',
                  border: '1px solid rgba(148, 163, 184, 0.1)',
                }}>
                  <h3 style={{ margin: '0 0 20px 0', fontSize: '16px', color: '#f8fafc' }}>Asset Allocation</h3>
                  <div style={{ display: 'flex', alignItems: 'center' }}>
                    <ResponsiveContainer width="50%" height={220}>
                      <PieChart>
                        <Pie data={allocationData} cx="50%" cy="50%" innerRadius={55} outerRadius={90} dataKey="value" stroke="none">
                          {allocationData.map((entry, index) => (
                            <Cell key={index} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => formatCurrency(value)} contentStyle={{ background: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} />
                      </PieChart>
                    </ResponsiveContainer>
                    <div style={{ flex: 1 }}>
                      {allocationData.map((item, i) => (
                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                          <div style={{ width: '12px', height: '12px', borderRadius: '3px', background: item.color }} />
                          <div style={{ flex: 1 }}>
                            <p style={{ margin: 0, fontSize: '14px', color: '#f8fafc' }}>{item.name}</p>
                            <p style={{ margin: 0, fontSize: '12px', color: '#64748b' }}>{formatCurrency(item.value)}</p>
                          </div>
                          <span style={{ fontSize: '14px', fontWeight: '600', color: item.color }}>{item.pct}%</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              {/* Dividend Payers */}
              <div style={{
                background: 'rgba(30, 41, 59, 0.6)',
                borderRadius: '16px',
                padding: '24px',
                border: '1px solid rgba(148, 163, 184, 0.1)',
              }}>
                <h3 style={{ margin: '0 0 20px 0', fontSize: '16px', color: '#10b981' }}>üí∞ Top Dividend Payers</h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>
                  {topDividendPayers.map((item, i) => (
                    <div key={i} style={{
                      padding: '16px',
                      borderRadius: '12px',
                      background: 'rgba(16, 185, 129, 0.1)',
                      border: '1px solid rgba(16, 185, 129, 0.2)',
                    }}>
                      <p style={{ margin: '0 0 4px 0', fontSize: '13px', fontWeight: '600', color: '#f8fafc' }}>{item.name.slice(0, 20)}</p>
                      <p style={{ margin: '0 0 8px 0', fontSize: '12px', color: '#64748b' }}>{formatCurrency(item.liveValue || item.mktVal)}</p>
                      <p style={{ margin: 0, fontSize: '20px', fontWeight: '700', color: '#10b981' }}>{item.dividendYield?.toFixed(1)}%</p>
                    </div>
                  ))}
                </div>
              </div>

              {/* Holdings Table */}
              <div style={{
                background: 'rgba(30, 41, 59, 0.6)',
                borderRadius: '16px',
                padding: '24px',
                border: '1px solid rgba(148, 163, 184, 0.1)',
              }}>
                <h3 style={{ margin: '0 0 20px 0', fontSize: '16px', color: '#f8fafc' }}>Holdings (Live Prices)</h3>
                <div style={{ overflowX: 'auto' }}>
                  <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                    <thead>
                      <tr style={{ borderBottom: '2px solid rgba(148, 163, 184, 0.2)' }}>
                        {['Name', 'Type', 'Qty', 'Price', 'Value (EUR)', 'Weight', 'Div Yield'].map(h => (
                          <th key={h} style={{ padding: '12px 16px', textAlign: 'left', fontSize: '11px', color: '#94a3b8', textTransform: 'uppercase' }}>{h}</th>
                        ))}
                      </tr>
                    </thead>
                    <tbody>
                      {investedStocks.map((item, i) => (
                        <tr key={i} style={{ borderBottom: '1px solid rgba(148, 163, 184, 0.1)' }}>
                          <td style={{ padding: '14px 16px', fontSize: '13px', fontWeight: '500' }}>{item.name}</td>
                          <td style={{ padding: '14px 16px' }}>
                            <span style={{
                              padding: '4px 8px',
                              borderRadius: '6px',
                              fontSize: '10px',
                              fontWeight: '600',
                              background: item.type === 'Stock' ? 'rgba(139, 92, 246, 0.2)' : item.type === 'Bond ETF' ? 'rgba(6, 182, 212, 0.2)' : 'rgba(16, 185, 129, 0.2)',
                              color: item.type === 'Stock' ? '#a78bfa' : item.type === 'Bond ETF' ? '#22d3ee' : '#34d399',
                            }}>{item.type}</span>
                          </td>
                          <td style={{ padding: '14px 16px', fontSize: '13px', color: '#94a3b8' }}>{item.quantity?.toLocaleString()}</td>
                          <td style={{ padding: '14px 16px', fontSize: '13px' }}>
                            {item.livePrice ? `${item.liveCurrency} ${item.livePrice.toFixed(2)}` : '‚Äî'}
                          </td>
                          <td style={{ padding: '14px 16px', fontSize: '13px', fontWeight: '600' }}>{formatCurrency(item.liveValue || item.mktVal)}</td>
                          <td style={{ padding: '14px 16px', fontSize: '13px' }}>{((item.liveValue || item.mktVal) / totals.totalValue * 100).toFixed(2)}%</td>
                          <td style={{ padding: '14px 16px', fontSize: '13px', color: item.dividendYield > 0 ? '#10b981' : '#64748b' }}>
                            {item.dividendYield ? `${item.dividendYield.toFixed(1)}%` : '‚Äî'}
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}

          {/* RISK TAB */}
          {activeTab === 'risk' && riskMetrics && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                {[
                  { label: 'Max Drawdown', value: `-${riskMetrics.maxDrawdown}%`, sub: riskMetrics.drawdownPeriod, color: '#ef4444' },
                  { label: 'Annualized Volatility', value: `${riskMetrics.annualizedVol}%`, sub: `Monthly: ${riskMetrics.monthlyVol}%`, color: '#f59e0b' },
                  { label: 'Win Rate', value: `${riskMetrics.hitRatio}%`, sub: `${riskMetrics.positiveMonths} up / ${riskMetrics.negativeMonths} down`, color: '#10b981' },
                  { label: '3Y Total Return', value: `${riskMetrics.totalReturn}%`, sub: 'EU 60/40 Benchmark', color: '#8b5cf6' },
                ].map((metric, i) => (
                  <div key={i} style={{
                    background: 'rgba(30, 41, 59, 0.6)',
                    borderRadius: '16px',
                    padding: '24px',
                    border: '1px solid rgba(148, 163, 184, 0.1)',
                  }}>
                    <p style={{ color: '#94a3b8', fontSize: '12px', margin: '0 0 8px 0', textTransform: 'uppercase' }}>{metric.label}</p>
                    <p style={{ fontSize: '28px', fontWeight: '700', margin: 0, color: metric.color }}>{metric.value}</p>
                    <p style={{ color: '#64748b', fontSize: '12px', margin: '4px 0 0 0' }}>{metric.sub}</p>
                  </div>
                ))}
              </div>

              <div style={{
                background: 'rgba(30, 41, 59, 0.6)',
                borderRadius: '16px',
                padding: '24px',
                border: '1px solid rgba(148, 163, 184, 0.1)',
              }}>
                <h3 style={{ margin: '0 0 16px 0', fontSize: '16px', color: '#f8fafc' }}>Monthly Returns Distribution</h3>
                <ResponsiveContainer width="100%" height={300}>
                  <BarChart data={benchmarkData}>
                    <CartesianGrid strokeDasharray="3 3" stroke="rgba(148, 163, 184, 0.1)" />
                    <XAxis dataKey="month" stroke="#64748b" fontSize={10} interval={2} />
                    <YAxis stroke="#64748b" fontSize={10} tickFormatter={(v) => `${v}%`} />
                    <Tooltip formatter={(v) => [`${v.toFixed(2)}%`, 'Return']} contentStyle={{ background: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }} />
                    <Bar dataKey="return" radius={[2, 2, 0, 0]}>
                      {benchmarkData?.map((entry, index) => (
                        <Cell key={index} fill={entry.return >= 0 ? '#10b981' : '#ef4444'} />
                      ))}
                    </Bar>
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          )}

          {/* CURRENCY TAB */}
          {activeTab === 'currency' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              {/* Info box explaining underlying exposure */}
              <div style={{ 
                background: 'rgba(245, 158, 11, 0.1)', 
                borderRadius: '12px', 
                padding: '16px', 
                border: '1px solid rgba(245, 158, 11, 0.2)' 
              }}>
                <p style={{ margin: 0, fontSize: '13px', color: '#fbbf24' }}>
                  üí° <strong>Underlying Currency Exposure:</strong> This shows your TRUE currency exposure based on underlying assets, not just trading currency. 
                  For example, Vanguard S&P 500 ETF trades in EUR but holds USD assets, so it counts as USD exposure.
                </p>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px' }}>
                <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(6, 182, 212, 0.3)' }}>
                  <p style={{ color: '#94a3b8', fontSize: '12px', margin: '0 0 8px 0', textTransform: 'uppercase' }}>EUR Exposure (Underlying)</p>
                  <p style={{ fontSize: '28px', fontWeight: '700', margin: 0, color: '#06b6d4' }}>{formatCurrency(totals.eurExposure)}</p>
                  <p style={{ color: '#06b6d4', fontSize: '14px', margin: '4px 0 0 0' }}>{(totals.eurExposure / totals.totalValue * 100).toFixed(1)}%</p>
                </div>
                <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(245, 158, 11, 0.3)' }}>
                  <p style={{ color: '#94a3b8', fontSize: '12px', margin: '0 0 8px 0', textTransform: 'uppercase' }}>USD Exposure (Underlying)</p>
                  <p style={{ fontSize: '28px', fontWeight: '700', margin: 0, color: '#f59e0b' }}>{formatCurrency(totals.usdExposure)}</p>
                  <p style={{ color: '#f59e0b', fontSize: '14px', margin: '4px 0 0 0' }}>{(totals.usdExposure / totals.totalValue * 100).toFixed(1)}%</p>
                </div>
                <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(148, 163, 184, 0.2)' }}>
                  <p style={{ color: '#94a3b8', fontSize: '12px', margin: '0 0 8px 0', textTransform: 'uppercase' }}>Current EUR/USD</p>
                  <p style={{ fontSize: '28px', fontWeight: '700', margin: 0, color: '#f8fafc' }}>{fxRate.toFixed(4)}</p>
                  <p style={{ color: '#64748b', fontSize: '14px', margin: '4px 0 0 0' }}>1 EUR = {fxRate.toFixed(4)} USD</p>
                </div>
              </div>

              <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '32px', border: '1px solid rgba(148, 163, 184, 0.1)' }}>
                <h3 style={{ margin: '0 0 8px 0', fontSize: '20px', color: '#f8fafc' }}>üí± Currency Risk Simulator</h3>
                <p style={{ color: '#64748b', fontSize: '14px', marginBottom: '24px' }}>See how EUR/USD movements affect your portfolio (base: EUR)</p>
                
                <div style={{ marginBottom: '32px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                    <span style={{ color: '#ef4444', fontSize: '13px' }}>EUR strengthens (USD worth less)</span>
                    <span style={{ color: '#10b981', fontSize: '13px' }}>EUR weakens (USD worth more)</span>
                  </div>
                  <input type="range" min="-20" max="20" value={fxScenario} onChange={(e) => setFxScenario(Number(e.target.value))} style={{ width: '100%' }} />
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '8px' }}>
                    <span style={{ color: '#64748b', fontSize: '12px' }}>Rate ‚Üë</span>
                    <span style={{ fontSize: '20px', fontWeight: '700', color: fxScenario === 0 ? '#94a3b8' : fxScenario > 0 ? '#10b981' : '#ef4444' }}>
                      {fxScenario === 0 ? '0%' : fxScenario > 0 ? `EUR -${fxScenario}%` : `EUR +${Math.abs(fxScenario)}%`}
                    </span>
                    <span style={{ color: '#64748b', fontSize: '12px' }}>Rate ‚Üì</span>
                  </div>
                </div>

                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                  <div style={{ padding: '20px', borderRadius: '12px', background: 'rgba(148, 163, 184, 0.1)' }}>
                    <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>New EUR/USD</p>
                    <p style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#f8fafc' }}>{fxImpact.newRate.toFixed(4)}</p>
                  </div>
                  <div style={{ padding: '20px', borderRadius: '12px', background: fxImpact.impact >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)', border: `1px solid ${fxImpact.impact >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'}` }}>
                    <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>Portfolio Impact</p>
                    <p style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: fxImpact.impact >= 0 ? '#10b981' : '#ef4444' }}>
                      {fxImpact.impact >= 0 ? '+' : ''}{formatCurrency(fxImpact.impact)}
                    </p>
                  </div>
                  <div style={{ padding: '20px', borderRadius: '12px', background: fxImpact.impactPct >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)', border: `1px solid ${fxImpact.impactPct >= 0 ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'}` }}>
                    <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>Impact %</p>
                    <p style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: fxImpact.impactPct >= 0 ? '#10b981' : '#ef4444' }}>
                      {fxImpact.impactPct >= 0 ? '+' : ''}{fxImpact.impactPct.toFixed(2)}%
                    </p>
                  </div>
                  <div style={{ padding: '20px', borderRadius: '12px', background: 'rgba(139, 92, 246, 0.1)', border: '1px solid rgba(139, 92, 246, 0.3)' }}>
                    <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>New Portfolio</p>
                    <p style={{ margin: 0, fontSize: '24px', fontWeight: '700', color: '#a78bfa' }}>{formatCurrency(fxImpact.newTotal)}</p>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* SCENARIOS TAB */}
          {activeTab === 'scenarios' && (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
              <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '32px', border: '1px solid rgba(148, 163, 184, 0.1)' }}>
                <h3 style={{ margin: '0 0 8px 0', fontSize: '20px', color: '#f8fafc' }}>üéØ Position Scenario Analysis</h3>
                <p style={{ color: '#64748b', fontSize: '14px', marginBottom: '24px' }}>What if a specific holding moves up or down?</p>
                
                <div style={{ display: 'flex', gap: '16px', flexWrap: 'wrap', marginBottom: '24px' }}>
                  <div style={{ flex: '1', minWidth: '200px' }}>
                    <label style={{ display: 'block', fontSize: '13px', color: '#94a3b8', marginBottom: '8px' }}>Select Holding</label>
                    <select 
                      value={scenarioStock}
                      onChange={(e) => setScenarioStock(e.target.value)}
                      style={{
                        width: '100%',
                        padding: '12px 16px',
                        borderRadius: '10px',
                        border: '1px solid rgba(148, 163, 184, 0.2)',
                        background: '#1e293b',
                        color: '#f8fafc',
                        fontSize: '14px',
                      }}
                    >
                      <option value="">Choose...</option>
                      {investedStocks.map((item, i) => (
                        <option key={i} value={item.name}>{item.name}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div style={{ flex: '1', minWidth: '200px' }}>
                    <label style={{ display: 'block', fontSize: '13px', color: '#94a3b8', marginBottom: '8px' }}>Price Change (%)</label>
                    <input type="range" min="-50" max="50" value={scenarioChange} onChange={(e) => setScenarioChange(Number(e.target.value))} style={{ width: '100%' }} />
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '4px' }}>
                      <span style={{ color: '#64748b', fontSize: '12px' }}>-50%</span>
                      <span style={{ fontSize: '18px', fontWeight: '700', color: scenarioChange >= 0 ? '#10b981' : '#ef4444' }}>
                        {scenarioChange >= 0 ? '+' : ''}{scenarioChange}%
                      </span>
                      <span style={{ color: '#64748b', fontSize: '12px' }}>+50%</span>
                    </div>
                  </div>
                </div>

                {scenarioResult && !scenarioResult.error && (
                  <div style={{ background: 'rgba(6, 182, 212, 0.1)', borderRadius: '12px', padding: '24px', border: '1px solid rgba(6, 182, 212, 0.2)' }}>
                    <h4 style={{ margin: '0 0 16px 0', fontSize: '16px', color: '#22d3ee' }}>
                      üìä {scenarioResult.stock} {scenarioChange >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(scenarioChange)}%
                    </h4>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                      <div>
                        <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>Current Value</p>
                        <p style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>{formatCurrency(scenarioResult.currentValue)}</p>
                      </div>
                      <div>
                        <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>Value Change</p>
                        <p style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: scenarioResult.valueChange >= 0 ? '#10b981' : '#ef4444' }}>
                          {scenarioResult.valueChange >= 0 ? '+' : ''}{formatCurrency(scenarioResult.valueChange)}
                        </p>
                      </div>
                      <div>
                        <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>Portfolio Impact</p>
                        <p style={{ margin: 0, fontSize: '20px', fontWeight: '600', color: scenarioResult.portfolioImpact >= 0 ? '#10b981' : '#ef4444' }}>
                          {scenarioResult.portfolioImpact >= 0 ? '+' : ''}{scenarioResult.portfolioImpact.toFixed(2)}%
                        </p>
                      </div>
                      <div>
                        <p style={{ margin: '0 0 4px 0', fontSize: '12px', color: '#94a3b8' }}>New Portfolio</p>
                        <p style={{ margin: 0, fontSize: '20px', fontWeight: '600' }}>{formatCurrency(scenarioResult.newPortfolioValue)}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>

              <div style={{ background: 'rgba(30, 41, 59, 0.6)', borderRadius: '16px', padding: '24px', border: '1px solid rgba(148, 163, 184, 0.1)' }}>
                <h3 style={{ margin: '0 0 20px 0', fontSize: '16px', color: '#f8fafc' }}>Market Shock Scenarios</h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '16px' }}>
                  {[
                    { name: 'Market Crash', sub: 'Equities -25%', impact: -(totals.investedTotal * 0.25), pct: -((totals.investedTotal * 0.25) / totals.totalValue * 100) },
                    { name: 'Correction', sub: 'Equities -10%', impact: -(totals.investedTotal * 0.10), pct: -((totals.investedTotal * 0.10) / totals.totalValue * 100) },
                    { name: 'Bull Run', sub: 'Equities +20%', impact: totals.investedTotal * 0.20, pct: (totals.investedTotal * 0.20) / totals.totalValue * 100 },
                    { name: 'USD Crisis', sub: 'USD -15%', impact: -(totals.usdExposure * 0.15), pct: -((totals.usdExposure * 0.15) / totals.totalValue * 100) },
                  ].map((scenario, i) => (
                    <div key={i} style={{
                      padding: '20px',
                      borderRadius: '12px',
                      background: scenario.impact >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                      border: `1px solid ${scenario.impact >= 0 ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}`,
                    }}>
                      <p style={{ margin: '0 0 4px 0', fontSize: '14px', fontWeight: '600' }}>{scenario.name}</p>
                      <p style={{ margin: '0 0 12px 0', fontSize: '12px', color: '#64748b' }}>{scenario.sub}</p>
                      <p style={{ margin: '0 0 4px 0', fontSize: '24px', fontWeight: '700', color: scenario.pct >= 0 ? '#10b981' : '#ef4444' }}>
                        {scenario.pct >= 0 ? '+' : ''}{scenario.pct.toFixed(2)}%
                      </p>
                      <p style={{ margin: 0, fontSize: '13px', color: '#64748b' }}>
                        {scenario.impact >= 0 ? '+' : ''}{formatCurrency(scenario.impact)}
                      </p>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Footer */}
          <div style={{ marginTop: '40px', paddingTop: '24px', borderTop: '1px solid rgba(148, 163, 184, 0.1)', textAlign: 'center' }}>
            <p style={{ color: '#475569', fontSize: '12px', margin: 0 }}>
              ‚ö†Ô∏è For informational purposes only. Not financial advice. Data may be delayed.
            </p>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
